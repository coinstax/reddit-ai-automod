# Task: Implement Google Gemini Provider

## Objective
Create a new AI provider implementation for Google Gemini 1.5 Flash that implements the IAIProvider interface.

## File to Create
`/home/cdm/redditmod/src/ai/gemini.ts`

## Requirements

### 1. AGPL License Header
Add this header at the top of the file:
```typescript
/**
 * AI Automod - AI Automod for Reddit
 * Copyright (C) 2025 CoinsTax LLC
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */
```

### 2. Gemini API Specifications
- **Model**: `gemini-1.5-flash`
- **Endpoint**: `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`
- **Authentication**: API key passed as query parameter `?key={apiKey}`
- **Pricing**:
  - Input tokens (â‰¤128k context): $0.075 per 1M tokens
  - Output tokens: $0.30 per 1M tokens

### 3. API Request Format
```json
{
  "contents": [{
    "parts": [{"text": "prompt here"}]
  }],
  "generationConfig": {
    "temperature": 0.3,
    "maxOutputTokens": 1500
  }
}
```

### 4. API Response Format
```json
{
  "candidates": [{
    "content": {
      "parts": [{"text": "response here"}]
    }
  }],
  "usageMetadata": {
    "promptTokenCount": 100,
    "candidatesTokenCount": 50,
    "totalTokenCount": 150
  }
}
```

### 5. Interface to Implement (from provider.ts)
```typescript
export interface IAIProvider {
  readonly type: AIProviderType;
  readonly model: string;
  analyze(request: AIAnalysisRequest): Promise<AIAnalysisResult>;
  healthCheck(): Promise<boolean>;
  calculateCost(inputTokens: number, outputTokens: number): number;
  analyzeWithQuestions?(request: AIQuestionRequest): Promise<AIQuestionBatchResult>;
}
```

### 6. Implementation Requirements

**analyze() method**:
- Build prompt using `promptManager.buildPrompt()`
- Make HTTP POST request to Gemini API (use fetch)
- Extract JSON from response text field
- Parse and validate using `aiResponseValidator.validate()`
- Calculate cost using token counts from `usageMetadata`
- Return complete `AIAnalysisResult` with metadata

**analyzeWithQuestions() method**:
- Build prompt using `promptManager.buildQuestionPrompt()`
- Make HTTP POST request to Gemini API
- Extract JSON from response text field
- Validate using `aiResponseValidator.validateQuestionBatchResponse()`
- Calculate cost and return `AIQuestionBatchResult`

**healthCheck() method**:
- Send minimal request "Say OK"
- Timeout after 5 seconds
- Return boolean (never throw)
- Catch all errors and return false

**calculateCost() method**:
- Input cost: (inputTokens / 1,000,000) * 0.075
- Output cost: (outputTokens / 1,000,000) * 0.30
- Return total in USD

**Error handling**:
- Use `AIError` class with appropriate `AIErrorType`
- Classify errors (rate limit, timeout, invalid response, provider error)
- Log errors with correlation ID
- Re-throw errors for analyzer to handle fallback

### 7. Reference Implementations
- **Structure template**: `/home/cdm/redditmod/src/ai/openai.ts`
- **Error handling**: See `classifyError()` method in openai.ts
- **Prompt building**: See how openai.ts uses `promptManager`
- **Validation**: See how openai.ts uses `aiResponseValidator`

### 8. Key Differences from Other Providers
- Gemini uses HTTP fetch (not a client library)
- API key in query string, not Authorization header
- Response JSON is nested in `parts[0].text` field (needs JSON.parse)
- Token counts in `usageMetadata` object
- Temperature range 0-2 (use 0.3 like other providers)

### 9. TypeScript Best Practices
- Comprehensive JSDoc comments for class and all public methods
- Proper async/await usage (no promise chains)
- Type safety (no `any` types without good reason)
- Proper error boundaries with try/catch
- Clear logging with structured data

### 10. Example Usage
```typescript
const provider = new GeminiProvider('api-key-here');

// Analyze user
const result = await provider.analyze(request);
console.log('Risk:', result.overallRisk);

// Health check
const healthy = await provider.healthCheck();
console.log('Healthy:', healthy);

// Cost calculation
const cost = provider.calculateCost(2000, 500);
console.log('Cost:', cost);
```

## Success Criteria
- File compiles without TypeScript errors
- Implements all required interface methods
- Follows same structure as openai.ts
- Has AGPL header
- Has comprehensive JSDoc comments
- Handles errors properly
- Calculates costs accurately
- Uses fetch API for HTTP requests
- Parses nested JSON response correctly
